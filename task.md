# КОНСТРУИРОВАНИЕ ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ

## Контрольная работа № 2: Синхронное межсервисное взаимодействие.

**Дедлайн сдачи: 20 мая, 23:59**

*Формат сдачи КР определяется семинаристом. Задание выполняется на языке программирования, являющимся основным для семинарских занятий (иной язык только по согласованию с семинаристом).*

### Предисловие

**Преподавателям НИУ ВШЭ нужна ваша помощь!**

В связи с большим количеством студенческих отчетов по письменным работам, сервис антиплагиат не справляется с нагрузкой. Вам поручено разработать инструмент для анализа отчетов на антиплагиат и их статистическую обработки.

**Вся надежда на вас!**
**Ваш код — единственное оружие против цифрового хаоса.**

### В ходе общения с преподавателями выявлены следующие требования

Веб-приложение должно представлять функциональность «текстового сканера», который принимает на вход отчёт студента (в формате .txt) и выполняет его анализ, включая:
1.  **Подсчёт статистики:** количество абзацев; слов; символов.
2.  **Сравнение файлов на схожесть** (для выявления 100% плагиата среди ранее присланных отчетов).
3.  **Визуализация данных (облака слов)** – дополнительно, не обязательное к выполнению.

### Требуется: разработать микросервисную архитектуру серверной части веб-приложения

Архитектурный комитет предлагает следующее решение с четким разделением ответственности микросервисов (вы можете предложить свой вариант):
1.  **API Gateway** – отвечает только за routing запросов.
2.  **File Storing Service** – отвечает только за хранение и выдачу файлов.
3.  **File Analisys Service** – отвечает только за проведение анализа, хранение результатов и их выдачу.

### Критерии оценки

1.  **Реализация основных требований к функциональности** – **2 балла**
2.  **Распределение функциональности по микросервисам** – **4 балла**
    a.  Серверная часть веб-приложения состоит минимум из двух микросервисов.
    b.  Обработка ошибок (один из микросервисов упал).
3.  **Реализация коллекции Postman / Swagger**, которая должна демонстрировать функциональность реализованных микросервисов, охватывая все API – **1 балл**
4.  **Качество кода и документация** – **2 балла**
    a.  Хорошо организованный, модульный и “чистый” код.
    b.  Документация, включая краткое описание архитектуры системы и спецификацию АРІ.
5.  **Покрыто тестами более 65% кода** – **1 балл**

### Штрафы

1.  до **-2 баллов** за наличие ошибки во время выполнения кода;
2.  до **–5 баллов**, если программа не собирается;
3.  **-1 балл** за каждый день просрочки дедлайна;
4.  **-1 балл** за грубое игнорирование кодстайла.

**Документация к АРІ построения облака слов:** [https://quickchart.io/documentation/word-cloud-api/](https://quickchart.io/documentation/word-cloud-api/)

---

## Пользовательские сценарии (на основе диаграмм)

### 1. Загрузка файла

**Участвующие компоненты:** Пользователь, API Gateway, Files Storing Service, PostgreSQL (для Files Storing Service), File Storage (для Files Storing Service).

**Последовательность действий:**
1.  **Пользователь** загружает файл через **API Gateway**.
2.  **API Gateway** перенаправляет запрос на загрузку файла в **Files Storing Service**.
3.  **Files Storing Service**:
    a.  Считает хэш загруженного файла.
    b.  Проверяет в своей базе данных **PostgreSQL**, существует ли файл с таким хэшем.
    c.  **Если файл существует:** переходит к шагу 5 (возвращает ID существующего файла).
    d.  **Если такого файла нет:**
        i.  Сохраняет метаинформацию о файле (id, name, hash, location) в свою базу данных **PostgreSQL**.
        ii. Сохраняет содержимое файла (location -> content) в **File Storage**.
4.  (Шаг объединен с 3.d)
5.  **Files Storing Service** возвращает `id` файла (нового или уже существующего) в **API Gateway**.
6.  **API Gateway** перенаправляет ответ (id файла) **Пользователю**.

### 2. Анализ файла

**Участвующие компоненты:** Пользователь, API Gateway, Files Storing Service, File Analisys Service, PostgreSQL (для File Analisys Service), File Storage (для File Analisys Service и Word Cloud API), Word Cloud API (внешний сервис).

**Последовательность действий:**
1.  **Пользователь** отправляет запрос на анализ файла по `id` через **API Gateway**.
2.  **API Gateway** перенаправляет запрос (анализ файла по `id`) в **File Analisys Service**.
3.  **File Analisys Service**:
    a.  Пытается получить результаты ранее проведенного анализа для этого `id` файла из своей базы данных **PostgreSQL**.
    b.  **Если результаты найдены:** переходит к шагу 10 (возвращает результаты анализа).
    c.  **Если результаты не найдены:**
        i.  Запрашивает содержимое файла по `id` у **Files Storing Service**.
4.  **Files Storing Service** получает `location` файла по `id` из своей базы данных **PostgreSQL**.
5.  **Files Storing Service** получает содержимое файла из **File Storage** по `location`.
6.  **Files Storing Service** возвращает содержимое файла в **File Analisys Service**.
7.  **File Analisys Service** проводит анализ файла (подсчет статистики, сравнение с другими файлами – не детализировано на схеме).
8.  **File Analisys Service** (опционально, для облака слов):
    a.  Обращается к внешнему **Word Cloud API** для генерации облака слов.
    b.  **(8.1 на схеме)** **Word Cloud API** возвращает картинку облака слов.
9.  **File Analisys Service**:
    a.  **(9.1 на схеме)** Если была получена картинка облака слов, сохраняет её в **File Storage** (ассоциированный с File Analisys Service).
    b.  **(9.2 на схеме)** Сохраняет результаты анализа (включая `location` картинки, если есть) в свою базу данных **PostgreSQL**.
10. **File Analisys Service** возвращает результаты анализа (статистика, результат сравнения, `location` облака слов) в **API Gateway**.
11. **API Gateway** перенаправляет ответ (результаты анализа) **Пользователю**.

### 3. Получение файла

**Участвующие компоненты:** Пользователь, API Gateway, Files Storing Service, PostgreSQL (для Files Storing Service), File Storage (для Files Storing Service).

**Последовательность действий:**
1.  **Пользователь** отправляет запрос на получение файла по `id` через **API Gateway**.
2.  **API Gateway** перенаправляет запрос (запрос файла по `id`) в **Files Storing Service**.
3.  **Files Storing Service** получает `location` файла по `id` из своей базы данных **PostgreSQL**.
4.  **Files Storing Service** получает содержимое файла из **File Storage** по `location`.
5.  **Files Storing Service** возвращает содержимое файла в **API Gateway**.
6.  **API Gateway** перенаправляет ответ (содержимое файла) **Пользователю**.

### 4. Получение облака слов

**Участвующие компоненты:** Пользователь, API Gateway, File Analisys Service, File Storage (для File Analisys Service).
*(Примечание: PostgreSQL для File Analisys Service подразумевается, но не указан явно на этой диаграмме для данного потока, хотя он нужен для получения location из результатов анализа).*

**Последовательность действий:**
1.  **Пользователь** отправляет запрос на получение картинки облака слов по `location` (полученному ранее из результатов анализа) через **API Gateway**.
2.  **API Gateway** перенаправляет запрос (облако слов по `location`) в **File Analisys Service**.
    *(Примечание: Логичнее было бы, чтобы File Analisys Service сам доставал картинку из своего File Storage, а не просто перенаправлял location. Или же API Gateway мог бы напрямую обращаться к File Storage, если бы у него был такой доступ и знание о структуре хранения File Analisys Service. Схема показывает, что запрос идет в File Analisys Service).*
3.  **File Analisys Service** получает картинку по `location` из **File Storage** (ассоциированного с File Analisys Service).
4.  **File Analisys Service** возвращает картинку (результаты) в **API Gateway**.
5.  **API Gateway** перенаправляет ответ (картинка облака слов) **Пользователю**.